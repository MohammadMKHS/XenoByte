@using XenoByte.Models.API.Ethereum
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@model CheckEthereumWalletReputationModel

@{
    ViewData["Title"] = "Wallet Reputation Report";

    string RiskClass()
    {
        var hasRansom = Model?.threat_intelligence?.is_known_ransomware_address_local_db == true || 
                       Model?.threat_intelligence?.is_known_ransomware_address_api == true;
        var hasReports = (Model?.chainabuse_reports?.total_reports_count ?? 0) > 0;
        var isMalicious = Model?.overall_reputation?.@class?.ToLowerInvariant().Contains("malicious") == true;
        
        if (hasRansom || hasReports || isMalicious) return "malicious";
        
        // Check for suspicious patterns
        var hasSuspiciousPatterns = Model?.behavioral_patterns?.Any(p => 
            p.Contains("frequent") || p.Contains("rapid") || p.Contains("suspicious")) == true;
        if (hasSuspiciousPatterns) return "suspicious";
        
        return "clean";
    }

    string Check(bool v) => v ? "?" : "—";

    // Safe join
    string Join(IEnumerable<string> items) => items == null ? "N/A" : string.Join(", ", items);
    
    // Helper to check if a behavioral pattern exists
    bool HasPattern(string pattern) => Model?.behavioral_patterns?.Any(p => 
        p.ToLowerInvariant().Contains(pattern.ToLowerInvariant())) == true;
}

<link href="~/css/wallet-forensic-report.css" rel="stylesheet" />

<div class="content-section">
    <div class="reputation-score @RiskClass()">
        Overall Reputation:
        @if (RiskClass() == "malicious")
        {
            <span>?? HIGH RISK</span>
        }
        else if (RiskClass() == "suspicious")
        {
            <span>?? SUSPICIOUS</span>
        }
        else
        {
            <span>?? LIKELY CLEAN / LOW RISK</span>
        }
    </div>

    <h2>Basic Information</h2>
    <div class="section-content">
        <p class="info-item"><strong>Current Balance:</strong> @(Model?.basic_info?.current_balance_eth.ToString("0.########") ?? "0") ETH</p>
        <p class="info-item"><strong>Total Transactions:</strong> @(Model?.basic_info?.total_transactions ?? 0)</p>
        <p class="info-item"><strong>Last Transaction:</strong> @(string.IsNullOrWhiteSpace(Model?.basic_info?.last_transaction_time_utc) ? "N/A" : Model.basic_info.last_transaction_time_utc)</p>
        <p class="info-item"><strong>Blockchain Type:</strong> @(string.IsNullOrWhiteSpace(Model?.basic_info?.blockchain_type) ? "Unknown" : Model.basic_info.blockchain_type)</p>
        <p class="info-item"><strong>Inferred Wallet Type:</strong> @(string.IsNullOrWhiteSpace(Model?.basic_info?.inferred_wallet_type) ? "Uncertain" : Model.basic_info.inferred_wallet_type)</p>
    </div>

    <h2>Threat Intelligence</h2>
    <div class="section-content">
        <p>
            <strong>Ransomware (Local DB):</strong> @(Model?.threat_intelligence?.is_known_ransomware_address_local_db == true ? "Yes" : "No")
            &nbsp;|&nbsp;
            <strong>Ransomware (API):</strong> @(Model?.threat_intelligence?.is_known_ransomware_address_api == true ? "Yes" : "No")
        </p>
        <p><strong>Families (API):</strong> @(string.IsNullOrWhiteSpace(Model?.threat_intelligence?.ransomware_families_identified) ? "N/A" : Model.threat_intelligence.ransomware_families_identified)</p>

        @if (Model?.chainabuse_reports?.reports?.Any() == true)
        {
            <h3>Red Flags</h3>
            <ul>
                @foreach (var report in Model.chainabuse_reports.reports)
                {
                    <li class="threat-detected">@report.category: @report.description</li>
                }
            </ul>
        }
    </div>

    <h2>Behavioral & Pattern Analysis</h2>
    <div class="section-content">
        <ul>
            <li><span class="@(HasPattern("extremely rapid") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("extremely rapid"))</span> Extremely rapid transactions</li>
            <li><span class="@(HasPattern("rapid") || HasPattern("frequent") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("rapid") || HasPattern("frequent"))</span> Rapid transactions (? 5 minutes)</li>
            <li><span class="@(HasPattern("frequent") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("frequent"))</span> Frequent transactions (? 5 days)</li>
            <li><span class="@(HasPattern("automated") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("automated"))</span> Automated patterns (5s–1min)</li>
            <li><span class="@(HasPattern("high transaction") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("high transaction"))</span> High transaction count</li>
            <li><span class="@(HasPattern("large amount") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("large amount"))</span> Unusually large amounts received</li>
            <li><span class="@(HasPattern("dust attack") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("dust attack"))</span> Dust attack pattern</li>
            <li><span class="@(HasPattern("high.*fee") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("high.*fee"))</span> High transaction fee detected</li>
            <li><strong>Automated Tx Time Diff:</strong> N/A</li>
            <li><span class="@(HasPattern("dormant") ? "analysis-flag" : "analysis-clean")">@Check(HasPattern("dormant"))</span> Dormant for over a year</li>
        </ul>
        
        @if (Model?.behavioral_patterns?.Any() == true)
        {
            <h3>Additional Patterns Detected</h3>
            <ul>
                @foreach (var pattern in Model.behavioral_patterns)
                {
                    <li>@pattern</li>
                }
            </ul>
        }
    </div>

    <h2>Chainabuse Reports</h2>
    <div class="section-content">
        @if (Model?.chainabuse_reports != null)
        {
            <p>
                <strong>Total Reports:</strong> @Model.chainabuse_reports.total_reports_count
                @if (!string.IsNullOrWhiteSpace(Model.chainabuse_reports.url_scraped))
                {
                    <span> — <a href="@Model.chainabuse_reports.url_scraped" target="_blank">Source</a></span>
                }
            </p>

            @if (Model.chainabuse_reports.reports?.Any() == true)
            {
                var idx = 1;
                foreach (var report in Model.chainabuse_reports.reports)
                {
                    <div class="chainabuse-report-card">
                        <h5>Report @idx: @(string.IsNullOrWhiteSpace(report.category) ? "Unspecified" : report.category)</h5>
                        @if (!string.IsNullOrWhiteSpace(report.description))
                        {
                            <p><strong>Description:</strong> @report.description</p>
                        }
                        @if (!string.IsNullOrWhiteSpace(report.submitted_by))
                        {
                            <p><strong>Submitted By:</strong> @report.submitted_by</p>
                        }
                        @if (!string.IsNullOrWhiteSpace(report.submitted_date))
                        {
                            <p><strong>Submitted Date:</strong> @report.submitted_date</p>
                        }
                        @if (report.reported_addresses?.Any() == true)
                        {
                            <p><strong>Reported Addresses:</strong> @string.Join(", ", report.reported_addresses)</p>
                        }
                    </div>

                    idx++;
                }
            }
            else
            {
                <p><em>No detailed report items.</em></p>
            }
        }
        else
        {
            <p><em>No Chainabuse data.</em></p>
        }
    </div>
</div>